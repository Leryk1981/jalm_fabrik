# Context7 Helper Makefile
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡ Ð´Ð»Ñ Context7 Helper

.PHONY: help install test clean search generate status cleanup docker-build docker-run

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
PYTHON = python
PIP = pip
MODULE = context7_helper
CLI_SCRIPT = $(PYTHON) -m $(MODULE).cli

help: ## ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ
	@echo "Context7 Helper - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾Ð¸ÑÐº ÐºÐ¾Ð´Ð° Ð´Ð»Ñ JALM Full Stack"
	@echo ""
	@echo "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

install: ## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
	$(PIP) install -r requirements.txt
	$(PIP) install -e .

test: ## Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹
	$(PYTHON) -m pytest test_context7.py -v

test-coverage: ## Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼
	$(PYTHON) -m pytest test_context7.py --cov=$(MODULE) --cov-report=html

clean: ## ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/ dist/ .pytest_cache/ htmlcov/

search: ## ÐŸÐ¾Ð¸ÑÐº ÐºÐ¾Ð´Ð° (Ð¿Ñ€Ð¸Ð¼ÐµÑ€)
	$(CLI_SCRIPT) search --query "booking system" --top-k 3

generate: ## Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð² Ð¸Ð· Research Layer
	$(CLI_SCRIPT) generate --research-dir ../research --top-k 3

status: ## Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Context7 Helper
	$(CLI_SCRIPT) status

cleanup: ## ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²
	$(CLI_SCRIPT) cleanup --days 7

test-integration: ## Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸
	$(CLI_SCRIPT) test

# Docker ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
docker-build: ## Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°
	docker build -t context7-helper .

docker-run: ## Ð—Ð°Ð¿ÑƒÑÐº Ð² Docker
	docker run -it --rm \
		-v $(PWD)/../research:/app/research \
		-v $(PWD)/tool_candidates:/app/tool_candidates \
		-e CONTEXT7_API_KEY=$(CONTEXT7_API_KEY) \
		context7-helper

# Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ JALM Full Stack
jalm-integrate: ## Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ JALM Full Stack CLI
	@echo "Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Context7 Helper Ð² JALM CLI..."
	@if [ -f "../cli/commands/context7.py" ]; then \
		echo "âœ… Context7 Helper ÑƒÐ¶Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² CLI"; \
	else \
		echo "âŒ Context7 Helper Ð½Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² CLI"; \
		echo "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ cli/commands/context7.py Ð² ../cli/commands/"; \
	fi

# Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
dev-install: ## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
	$(PIP) install -r requirements.txt
	$(PIP) install -e .[dev]

format: ## Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð°
	black $(MODULE)/*.py
	black test_*.py

lint: ## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
	flake8 $(MODULE)/*.py
	flake8 test_*.py

# Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
demo: ## Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
	@echo "ðŸŽ¯ Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Context7 Helper"
	@echo ""
	@echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°:"
	$(CLI_SCRIPT) status
	@echo ""
	@echo "2. ÐŸÐ¾Ð¸ÑÐº ÐºÐ¾Ð´Ð°:"
	$(CLI_SCRIPT) search --query "fastapi endpoint" --top-k 2
	@echo ""
	@echo "3. Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:"
	$(CLI_SCRIPT) test

# ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
pipeline: ## Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°
	@echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° Context7 Helper"
	@echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°..."
	$(CLI_SCRIPT) status
	@echo "2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²..."
	$(CLI_SCRIPT) generate --research-dir ../research --top-k 3
	@echo "3. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
	$(CLI_SCRIPT) cleanup --days 7
	@echo "âœ… ÐŸÐ°Ð¹Ð¿Ð»Ð°Ð¹Ð½ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"

# Windows ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ
windows-install: ## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð° Windows
	python -m pip install -r requirements.txt
	python -m pip install -e .

windows-test: ## Ð¢ÐµÑÑ‚Ñ‹ Ð½Ð° Windows
	python -m pytest test_context7.py -v

windows-search: ## ÐŸÐ¾Ð¸ÑÐº Ð½Ð° Windows
	python -m context7_helper.cli search --query "booking system" --top-k 3

windows-generate: ## Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð° Windows
	python -m context7_helper.cli generate --research-dir ../research --top-k 3

# Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
docs: ## Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
	@echo "ðŸ“š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸..."
	@if command -v pdoc3 >/dev/null 2>&1; then \
		pdoc3 --html $(MODULE) --output-dir docs; \
		echo "âœ… Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð² docs/"; \
	else \
		echo "âŒ pdoc3 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: pip install pdoc3"; \
	fi

# Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
stats: ## Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
	@echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Context7 Helper:"
	@echo "Ð¤Ð°Ð¹Ð»Ñ‹ Python: $(shell find $(MODULE) -name '*.py' | wc -l)"
	@echo "Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ ÐºÐ¾Ð´Ð°: $(shell find $(MODULE) -name '*.py' -exec wc -l {} + | tail -1)"
	@echo "Ð¢ÐµÑÑ‚Ñ‹: $(shell find . -name 'test_*.py' | wc -l)"
	@echo "ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ñ‹: $(shell find tool_candidates -name '*.json' 2>/dev/null | wc -l || echo 0)" 